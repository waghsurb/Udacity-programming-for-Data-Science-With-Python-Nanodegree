/* QUERY 1: Movies Rental Duration Family-Friendly ********************************/

WITH family_category AS (
  SELECT f1.title AS film_title, c1.name AS category_name, f1.rental_duration , NTILE(4) OVER (ORDER BY f1.rental_duration) AS standard_quartile
  FROM film f1
  JOIN film_category fc
  ON f1.film_id = fc.film_id
  JOIN category c1
  ON fc.category_id = c1.category_id
  WHERE c1.name IN ('Animation', 'Children', 'Classics', 'Comedy', 'Family', 'Music'))
  
SELECT category_name, standard_quartile, COUNT(rental_duration)
FROM family_category
GROUP BY 1, 2
ORDER BY 1, 2;


/* QUERY 2: Top 10 Customerâ€™s Monthly Spending */

WITH top_ten AS(
  SELECT p1.customer_id, (c1.first_name||' '||c1.last_name) AS fullname, SUM(p1.amount) AS pay_amount
  FROM payment p1
  JOIN customer c1
  ON p1.customer_id = c1.customer_id
  GROUP BY 1, 2
  ORDER BY 3 DESC
  LIMIT 10)
  
SELECT DATE_TRUNC('month', p1.payment_date) pay_mon, tt.fullname AS name, COUNT(p1.payment_date) AS pay_count_per_mon, SUM(p1.amount) AS pay_amount
FROM payment p1
JOIN top_ten tt
ON p1.customer_id = tt.customer_id
GROUP BY 1,2
ORDER BY 2,1;

/* QUERY 3:Customer Base Distribution */

SELECT co1.country, COUNT(cu.customer_id)
FROM customer cu
JOIN address a
ON cu.address_id = a.address_id
JOIN city cit
ON a.city_id = cit.city_id
JOIN country co1
ON cit.country_id = co1.country_id
GROUP BY 1
ORDER BY 2 DESC;

/* QUERY 4: Popular Films for Most Popular Country */

WITH t1 AS (
  SELECT cou.country_id c_id, cou.country, COUNT(cus.customer_id)
  FROM customer cus
  JOIN address a
  ON cus.address_id = a.address_id
  JOIN city cit
  ON a.city_id = cit.city_id
  JOIN country cou
  ON cit.country_id = cou.country_id
  GROUP BY 1
  ORDER BY 3 DESC
  LIMIT 1), 

india_cust AS (
  SELECT cus.customer_id
  FROM customer cus
  JOIN address a
  ON cus.address_id = a.address_id
  JOIN city c
  ON a.city_id = c.city_id
  JOIN t1
  ON c.country_id = t1.c_id
  WHERE c.country_id = t1.c_id)

SELECT f.title AS film_title, COUNT(r.rental_id) AS rent_count
FROM film f
JOIN inventory i
ON f.film_id = i.film_id
JOIN rental r
ON i.inventory_id = r. inventory_id
JOIN india_cust ic
ON ic.customer_id = r.customer_id
WHERE r.customer_id = ic.customer_id
GROUP BY 1
HAVING COUNT(r.rental_id) >= 5
ORDER BY 2 DESC;



